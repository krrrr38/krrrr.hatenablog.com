---
Title: finagle-mysql/finagle-redis connection init sql/command stack modules
Category:
- Scala
Date: 2020-05-06T08:11:04+09:00
URL: https://krrrr.hatenablog.com/entry/2020/05/06/081104
EditURL: https://blog.hatena.ne.jp/krrrr/krrrr.hatenablog.com/atom/entry/26006613562627749
---

## これは何

finagleに以下のpatchを追加した

- finagle-mysql: [HikariCP](https://github.com/brettwooldridge/HikariCP) にあるconnection-init-sqlの機能
- finagle-redis: Connection作成時にすぐに一度だけAUTH, SELECTコマンドを発行する機能

[https://finagle.github.io/blog/2020/04/26/release-notes/:title]

[f:id:krrrr:20200506075143p:plain]

<!-- more -->

## finagle StackClient

finagleといえばStackClient, StackServerである。

[https://github.com/twitter/finagle/blob/8175b9e69ee22045e41a7eaa61c5cde117e701c6/finagle-core/src/main/scala/com/twitter/finagle/client/StackClient.scala#L90-L422:title]

finagleではhttp client, thrift client, mysql client, redis client...などはすべてReqを受け取ってRepを返すService[Req, Rep]として表される。

ssl接続にはhandshakeがいるし、mysqlと通信するServiceならmysql protocolを通す必要がある。これらの個々の機能はstack moduleとして、ServiceFactory[Req, Rep]をwrapする形でstackとして機能を積み上げている。

様々な通信方法がある中で、基本的な機能moduleを共通化して入れ込んでいるものが、StackClient/StackServerである。

このStackClientにstackとして積み上げられたmoduleには、Roleという個々のmoduleを特定するための名前がつけられており、これらのRoleを指定することで、特定のRoleを入れ替えたり、特定のRoleの後に別のRoleを入れたりもできる。

## connection init sql/command

connection init sql/commandについては、リクエスト毎にredisに認証リクエストを送る必要はないし、コネクション作成後に1度だけ実行すれば良い処理になる。

StackClientが持つmoduleのひとつに、[Role.prepConn](https://github.com/twitter/finagle/blob/8175b9e69ee22045e41a7eaa61c5cde117e701c6/finagle-core/src/main/scala/com/twitter/finagle/client/StackClient.scala#L56-L61)がある。このRoleでは、通信する準備が出来た状態を表し、[空実装になっている](https://github.com/twitter/finagle/blob/8175b9e69ee22045e41a7eaa61c5cde117e701c6/finagle-core/src/main/scala/com/twitter/finagle/client/StackClient.scala#L99-L106)。

今回の実装では、このRole.prepConnの後に一度だけ処理を入れる機能をパッチとして追加した。

これでfinagle-mysqlでも[kamipo traditional](https://songmu.jp/riji/entry/2015-07-08-kamipo-traditional.html)をclient側から指定することが出来るようになった。
