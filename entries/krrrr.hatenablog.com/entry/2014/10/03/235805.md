---
Title: Play2.3のPlugin
Category:
- Scala
- Play
Date: 2014-10-03T23:58:05+09:00
URL: https://krrrr.hatenablog.com/entry/2014/10/03/235805
EditURL: https://blog.hatena.ne.jp/krrrr/krrrr.hatenablog.com/atom/entry/8454420450067311573
---

Scala + Play framework 2.3 ってとこでアルバイト初めて一月半ぐらい経とうとしてる。
[OOSC読んだり](http://krrrr.hatenablog.com/entry/2014/09/21/231526)、ポスター発表してたりもしたけど落ち着き始めたので、Playの中身ちゃんと知ろうとか考えてる  

Playで設定を読み込み、リクエストを受け付ける前にする云々、特にPluginを見る。
PlayはPluginという機構を使って様々な前準備及び終了時の後処理を行う。
(コレ以外にもDBPluginなど直接Application.pluginを用いて呼び出す事も出来るが今回の範疇ではない)

playframeworkが提供している様々なPluginについて見て行きたいと思うが、本題に入る前にPluginとは何なのかにあたる部分について触れる

__ちなみに2.4からはPluginの機構は使われなくなるので、これは2.3.xまでの話。__
(さすがにまだ2.4系を本番で使ってる人はいない...?)
一応2.4系はplay moduleってのをDIしてく、って世界観らしい

以下で触れるのは2.3.xブランチの[このcommit上](https://github.com/playframework/playframework/tree/a5a11b9dc799d730713c3cbadf35a3e06f2b585b)の話、ただコードを読むだけ
<!-- more -->
## 前振り

### PlayApplication

- consoleとかで使える
  - `StaticApplication extends ApplicationProvider`
- Test Mode
  - `play.core.TestApplication extends ApplicationProvider`
- Dev Mode
  - `play.core.ReloadableApplication extends ApplicationProvider`

これらの中で`Play.start(application)`が呼ばれてる。
startの中では、routesを遅延評価で構築したり、pluginを順に読み込んだりしている(読み込むpluginについては後述)。
applicationは`play.api.DefaultApplciation`などが用いられ、色んな設定とかこいつが用意してる

### play.api.DefaultApplication

```scala
class DefaultApplication(
  override val path: File,
  override val classloader: ClassLoader,
  override val sources: Option[SourceMapper],
  override val mode: Mode.Mode) extends Application with WithDefaultConfiguration with WithDefaultGlobal with WithDefaultPlugins
```

`Application`, `WithDefaultConfiguration`, `WithDefaultGlobal`, `WithDefaultPlugins`で成り立ってる

- Applicationの主要な構成要素
  - Applicationのルートとなる`path`
  - Globalなどのクラスを読み込むための`classloader`
  - エラー時にブラウザにソースを載せるために用いられる`sources`
  - 実行時のmode(Dev/Test/Prod)を示す`mode`
  - Global.scalaから得られる`global`
    - これは後ほど述べるpluginsの重み10000で実行されるものとなる
    - `getControllerInstance`とかあったのか
  - application.confなどを読み込み生成される`configuration`
  - アプリケーション実行時などに利用される`plugins`
  - 後のPlay.start時に評価されるルーティングを保持する`routes`
  - loggerの設定
  - エラーハンドル
  - そして`plugin`メソッドによる別途Pluginの呼び出し(今回の対象外)
  - ...

- WithDefaultConfigurationとは
  - `Application`をself type annotationとして、上記`configuration`を読み込むtrait
  - `com.typesafe.config.Config`軽くをラップしたものを利用している

- WithDefaultGlobalとは
  - `WithDefaultConfiguration`を持つ`Application`をself type annotationに持つtrait
  - `configuration`に書かれた設定からGlobalPluginとなるクラスを探す
  - 特に指定がなければ基本的なエラー処理等のみが定義された`GlobalSettings`をそのまま用いる`DefaultGlobal`が用いられる
  - `globalInstance`では`javaGlobal`を取りにいき、無ければ`scalaGlobal`を取りに行く
  - 得られたものはGlobalPluginとして、実行される

- WithDefaultPluginsとは
  - 設定ファイル(play.plugins)に書かれた文字列から各種Pluginをclassloaderを用いて用意する
  - 自身が定義したPluginや、先に説明したGlobalPlugin、その他様々なライブラリが提供するPlayのPluginを用意する

playframework/playframeworkのプロジェクトにはいくつものサブプロジェクトなども含まれているが、通して以下のようなplugin設定ファイルが存在する

```
./framework/src/play/src/main/resources/play.plugins
./framework/src/play-cache/src/main/resources/play.plugins
./framework/src/play-java/src/main/resources/play.plugins
./framework/src/play-java-ebean/src/main/resources/play.plugins
./framework/src/play-java-jdbc/src/main/resources/play.plugins
./framework/src/play-java-jpa/src/main/resources/play.plugins
./framework/src/play-java-ws/src/main/resources/play.plugins
./framework/src/play-jdbc/src/main/resources/play.plugins
./framework/src/play-ws/src/main/resources/play.plugins
./framework/test/integrationtest/conf/play.plugins
```

## Pluginについて
ここまでで、設定や各種Pluginを使う用意が出来た。
では、Pluginとは何なのか。

見やすいようにdocumentを削ったりしたが、以下のような宣言がなされている。
全てのPluginはこのPluginを実装している。

```
trait Plugin {
  // Called when the application starts.
  def onStart() {}

  // Called when the application stops.
  def onStop() {}

  // Is the plugin enabled?
  def enabled: Boolean = true
}
```

そして、`Play.start`の中で`onStart()`が、`Play.stop`の中で`onStop()`が順に実行される。

ここで__順に__、と述べたのば、pluginの設定ファイルの行頭についた数字がpriorityとなり値の__小さい順__に`onStart()`では実行される。
逆に`Play.stop`では数字の__大きい順__にPluginの`onStop()`が実行される。

Playframeworkのドキュメントの中でも説明がある通り、他のPluginに依存するPluginを作る際にはこのpriorityに注意する必要がある。
特に他のPluginに影響を及ぼさないPluginならば10000より大きいpriorityを設定するのが良い。

実行前には各種pluginが設定ファイルなどを眺めてenabledとなるもののみが実行される。
例えばなぜかEhCachePluginが入った状態で、[mumoshu/play2-memcached - GitHub](https://github.com/mumoshu/play2-memcached)を使いたい場合には、READMEにある通り、application.confに`enhcacheplugin=desabled`と書いてEhCachePluginが実行されないように出来る。

## 各種Pluginを眺める

libraryDependenciesに何も書かないPlay projectの場合`./framework/src/play/src/main/resources/play.plugins`に書かれたPluginのみが実行される。
jdbcをlibryDependenciesに含めた場合には`./framework/src/play-jdbc/src/main/resources/play.plugins`に書かれたPluginも実行される。
1つ1つ見ていくわけだが、全部見るのは億劫なので良く使うものだけ今回は眺める。

```
==> ./framework/src/play/src/main/resources/play.plugins <==
1:play.core.system.MigrationHelper
100:play.api.i18n.DefaultMessagesPlugin
1000:play.api.libs.concurrent.AkkaPlugin
10000:play.api.GlobalPlugin

==> ./framework/src/play-cache/src/main/resources/play.plugins <==
600:play.api.cache.EhCachePlugin

==> ./framework/src/play-jdbc/src/main/resources/play.plugins <==
200:play.api.db.BoneCPPlugin
500:play.api.db.evolutions.EvolutionsPlugin
```

こんなとこ

### 1:play.core.system.MigrationHelper
2.2.xにはなかったけど2.3.xになって増えたもの。
名前の通り、Play frameworkのversion移行時に設定ファイルの単位が変わった事で挙動が変わりそうな事を、起動前にチェックしwarningを出してくれる。
2.3.xへの移行時にチェックしてる内容は`session.maxAge`の単位が数値(integer)から期間表記(e.g. 1h 30m)になる事である。

### 100:play.api.i18n.MessagesPlugin
多言語用Pluginで、`Lang.availables`でconfから有効なlangを取得し、多言語化用の変換Mapを用意する  
有効なlangを用いた`messages.lang`、`messages`、`messages.default`などをパースして後者優先で上書きしたMapを作る  
translate時はこいつを見てkeyを渡し、`java.text.MessageFormat`に食わせて変換結果を返す  
MessageFormatがそのまま使われるから[Playframework の I18N で 1st, 2nd, 3rd, 4th, ... - Qiita](http://qiita.com/kawachi/items/e97f8686e3e1af388f6d)みたいなことも出来る

### 200:play.api.db.BoneCPPlugin
[こちらのissue](https://github.com/playframework/playframework/issues/2445)でHikariCPとどちらを使うかを争って、以前使われ続けてるBoneCP。
([知らなかったけど1週間前にこんなコメント増えてた](https://github.com/playframework/playframework/issues/2445#issuecomment-56973485))

DBへのコネクションを取得出来るDataSourceを作るのが目的

`onStart()`では設定ファイルの情報を基に、DBのコネクションを生成出来るかをチェックしている。
チェックする時にBoneCPApiオブジェクトが作られるわけだが、作られる際にDataSourceを作り、DBのコネクションプール周りの設定を入れまくったConnectionHookをこいつに登録している。
BoneCPの場合javax.sql.DataSourceを継承したBoneCPDataSourceを持っており、こいつからコネクションを取得する。
BoneCPDataSourceはBoneCP(ConnectionPool)を持っており...、これ以上は今回は関係ない

`onStop()`では全てのDataSourceを閉じる処理を行ってる、なるほど

ちなみに...
slickのplay用Plugin[playframework/play-slick...play.plugins - GitHub](https://github.com/playframework/play-slick/blob/0.8.x/code/src/main/resources/play.plugins)((0.8.xがPlay2.用))はpriorityが400,401となっており、この箇所で実行される。
400の方では、(Playから使えるコネクション生成出来る)Databaseオブジェクトを全てclearして、401の方ではevolutionを生成している。
`"# --- Created by "`というコメントで始まるかどうかでevolutionをするかを判定してるのが意味わからん。
が、スキーマが変わる毎にevolutionを自動生成してくれるのはありがたい

ちなみに確認ではあるが...
コネクションを取得するのは`play.api.DB.getConnection`から`Applicaiton.plugin[DBPlugin].map(_.api.getConnection(...))`とした時などに行われ、処理が終了した時に開放される。

### 500:play.api.db.evolutions.EvolutionsPlugin
priorityが500未満のPluginでevolutionファイルが生成されているはずである。
もしevolutionを吐くpluginを書くなら500未満にしなければ動かない。

設定の`evolutions.use.locks`を見てあればロックしながら、無ければロックせずにevolutionを実行する((マジか、知らなかった))。
evolutionの管理は`play_evolutions`というテーブルを勝手に作って用いている。
これらは`onStart()`で行っており、`onStop()`では何もしていない。

### 600:play.api.cache.EhCachePlugin
お手軽メモリキャッシュ、EhCacheのためのPlugin。
初めにehcache.xmlのような設定ファイルを読みつつ、保存先を管理するCacheManagerを作成し、playと名づけた保存先を作る。
((lazy valで定義しておいた変数を評価して実際に処理を実行させる感じ、なんとなく好きだ))
`onStop()`では管理してるCacheManagerそのものを破棄してる。

### 1000:play.api.libs.akka.AkkaPlugin
`onStart()`は何もしない。
最初の`Akka.system.actorOf[Props[MyActor]]`のような呼び出しがあった時に初めてActorSystemが作られる。
ログにも出るんだけど、GlobalPluginのonStartでスケジューラなど起動してるから気が付かなかった...
((関係無いけど、actorOfした時にmakeChildで子供が作られるとこまで軽くみたら普通にmailboxみたいな変数やクラスがあってこれ例えで出した名前じゃなかったんだって))

`onStop()はActorSystem自体を閉じる

### 10000:play.api.GlobalPlugin
`onStart()`時にはユーザが定義したGlobalの`onStart()`を中で呼び出す。
`onStop()`時も同様にユーザが定義したGlobalの`onStop()`を中で呼び出す。

ちなみにユーザ定義のGlobalにだけ`beforeStart()`という関数があるのだが、これはGlobalPluginオブジェクトが生成された時に実行されるため、上記で上げたような各種Pluginの`onStart()`が実行される前に行う処理を定義出来る。
逆にこの中ではDBに対する処理などは行えないので注意。

## 締め
2.4系にあげる前にplay moduleも読むか、play-core読むかNettyあたり読みたい

