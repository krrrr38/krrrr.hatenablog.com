---
Title: mackerel-agentから見るサーバリソースの見方
Category:
- mackerel
- サーバー
- golang
Date: 2014-08-16T22:10:29+09:00
URL: https://krrrr.hatenablog.com/entry/2014/08/16/221029
EditURL: https://blog.hatena.ne.jp/krrrr/krrrr.hatenablog.com/atom/entry/12921228815730376042
---

** なにこれ
はてなが出してるサーバ監視サービスである[https://mackerel.io/:title=mackerel]
サーバに常駐させるagentがGitHubで公開されてる
[https://github.com/mackerelio/mackerel-agent:title]

これを眺める事でどの値を見るべきなのか、どのようにして取得するのかを主要な所のみ学べるのでは
[http://www.flickr.com/photos/82825649@N00/438036244:image=http://farm1.staticflickr.com/187/438036244_61c87d7dce.jpg]
[http://www.flickr.com/photos/82825649@N00/438036244:title=photo by richard ling]
====
** そもそも
[http://help-ja.mackerel.io/entry/spec/metrics:title] があるわけだけど、どうやって取ってるのとかを見るのが趣旨

** 送信タイプ
agentは長い周期で定期的に送信する値と短い周期で定期的に送信する値を持つ
package名にならって前者をspec、後者をmetricsと呼ぶ
以下のようなテンプレートに習って記述する、つもりだったけどグダグダになった

- mackerel-agentで見る構造体名の一部を用いた区分
-- [command|file]<code>command名 or ファイル名</code>
-- (comment)
--- [option]: 個々の値の取り方とか, 個々の値の取り方とか,...
--- [regex]: 個々の値の取り方とか, 個々の値の取り方とか,...

個々の値はコマンドのオプションを使ったり、まとめて出した結果から正規表現で抜き出したりもする
regexにはソースにきちんと正規表現が書いてるが、コピペするのは億劫なのでその一部分のみを載せる
コマンド1発で出てくる値を用いている場合もある

ちなみに、mackerel-agentのソースは [https://github.com/mackerelio/mackerel-agent/tree/124f303f3c62edd12514fba57f0c8aa307ad396f:title] のコミットのものを見てるし、linuxのしか見てない

** spec
specは初回登録時にすぐに実行され、その後は送信頻度を少なくするように周期を長くとって送信する値である
頻繁に変化するのではなく予めサーバに決められたスペックなどを表すものになっているはず
無限ループを実装する関数の中の[https://github.com/mackerelio/mackerel-agent/blob/124f303f3c62edd12514fba57f0c8aa307ad396f/command/command.go#L137-L143:title=このあたり]でgoroutineとして呼ばれてる
以下の5種類の区分から値が複数個送信される
- Kernel
-- [command]<code>uname</code>
--- [option]: -s, -r, -v, -m, -o
- CPU
-- [file]<code>/proc/cpuinfo</code>
--- [regex]processor, vendor_id, cpu family, model, stepping, physical id, core id, cpu cores, model name, cpu MHz, cache size, flags
- Memory
-- [file]<code>/proc/meminfo</code>
--- [regex]MemTotal, MemFree, Buffers, Cached, Active, Inactive, HighTotal, HighFree, LowTotal, LowFree, Dirty, Writeback, AnonPages, Mapped, Slab, SReclaimable, SUnreclaim, PageTables, NFS_Unstable, Bounce, CommitLimit, Committed_AS, VmallocTotal, VmallocUsed, VmallocChunk, SwapCached, SwapTotal, SwapFree
- BlockDevice
-- [file]<code>/sys/block/:deviceName/size</code>
-- [file]<code>/sys/block/:deviceName/removable</code>
- Filesystem
-- [command]<code>df -P</code>
--- 全て送信 ⇒ Filesystem, 1024-blocks, Used, Available, Capacity, Mounted on

** metrics
metricsは短い周期で値が収集され、送信されるもの
動的にすぐに値が変化して、特にサーバリソースの監視すべき値が含まれているはず
[https://github.com/mackerelio/mackerel-agent/blob/124f303f3c62edd12514fba57f0c8aa307ad396f/agent/agent.go#L54-L65:title=この辺]で値の収集が行われ、[https://github.com/mackerelio/mackerel-agent/blob/124f303f3c62edd12514fba57f0c8aa307ad396f/command/command.go#L147-L171:title=この辺]で周期的に送信している((どうでも良いけど参照透過性について固執せず、書いてる言語によって完全に頭切り替えるのが良い))
以下の6種類の区分から値が複数個送信される
- Loadavg5
-- [file]<code>/proc/loadavg</code>
-- (2列目、つまり過去5分間の CPU 及び IO の使用率のみ送信)
- Cpuusage
-- [file]<code>/proc/stat</code>
-- (合計値である出力の1行目とcpu数を基に、<code>// percentage of increased amount of CPU time</code>、増加量の百分率を送信してる)
- Memory
-- [file]<code>/proc/meminfo</code>
--- [regex]MemTotal, MemFree, Buffers, Cached, Active, Inactive, SwapCached, SwapTotal, SwapFree
- Uptime
-- [file]<code>/proc/uptime</code>
-- (1列目、つまりシステムが起動してから経過した合計時間のみ送信)
- Interface
-- [file]<code>/proc/net/dev</code>
-- (全ての値の増加量を送信)
--- receive: bytes, packets, errs, drop, fifo, frame, compressed, multicast
--- transmit: bytes, packets, errs, drop, fifo, colls, carrier, compressed
- Disk
-- [file]<code>/proc/diskstats</code>
-- (4列目以降全ての値の増加量を送信)

[http://help-ja.mackerel.io/entry/advanced/custom-metrics:title] で用意された値もmetricsで送信されてるけど割愛

** 結び
個々の取得する値に対して何か書こうと思ったけど多いからやめた
