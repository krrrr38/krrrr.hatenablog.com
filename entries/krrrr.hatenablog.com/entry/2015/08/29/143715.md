---
Title: SpringのアノテーションがLoadされるまでの流れ
Category:
- Spring
Date: 2015-08-29T14:37:15+09:00
URL: https://krrrr.hatenablog.com/entry/2015/08/29/143715
EditURL: https://blog.hatena.ne.jp/krrrr/krrrr.hatenablog.com/atom/entry/6653458415119404462
---

[https://github.com/spring-projects/spring-framework:embed:cite]

[最新コミット](https://github.com/spring-projects/spring-framework/tree/164bed5c3f9526ab7d898e7e5e6740a09777f3e1)のコードを読む

今回は、ウェブアプリケーションを立ち上げる際に、`@Transactional`アノテーションがどのようにしてロードされて呼び出されているのかを見る

<!-- more -->

利用されるのは、`spring-tx`、`spring-beans`、`spring-context`、`spring-web`の4つのプロジェクト

- `spring-tx`
  - `SpringTransactionAnnotationParser.parseTransactionAnnotation`
  - `AnnotationTransactionAttributeSource.findTransactionAttribute(Method/Class)`
  - `AbstractFallbackTransactionAttributeSource.computeTransactionAttribute`
  - `AbstractFallbackTransactionAttributeSource.getTransactionAttribute`
  - `TransactionAspectSupport.invokeWithInTransaction`
    - ここでTransactionAttrubute、PlatformTransactionManagerがある場合のみ、Transaction処理が実行される
  - `TransactionInterceptor.invoke` (MethodInterceptor)
  - `AnnotationDrivenBeanDefinitionParser.AopAutoProxyConfigurer`
  - `TxNamespaceHandler.init`
- `spring-beans`
  - `NamespaceHandlerSupport.resolve`
  - `BeanDefinitionParserDelegate.parseCustomElement/decorateIfRequired`
  - ...
  - `BeanDefinitionParserDelegate.parseBeanDefinitionElement`
  - `DefaultBeanDefinitionDocumentReader.registerBeanDefinitions`
  - `XmlBeanDefinitionReader.registerBeanDefinitions`
  - ...
  - `XmlBeanDefinitionReader.loadBeanDefinitions`
  - ...
  - `GenericXmlApplicationContext.load`
  - ...
  - `ConfigurationClassBeanDefinitionReader.loadBeanDefinitions`
  - `ConfigurationClassPostProcessor.processConfigBeanDefinitions`
  - `ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry`
- `spring-context`
  - `PostProcessRegistrationDelegate.invokeBeanFactoryPostProcessors`
  - `AbstractApplicationContext.invokeBeanFactoryPostProcessors`
  - `AbstractApplicationContext.refresh`
- `spring-web`
  - `ContextLoader.configureAndRefreshWebApplicationContext`
  - `ContextLoader.initWebApplicationContext`
  - `ContextLoaderListener.contextInitialized` (ServletContextListener)

ということで、`ServletContextListener`に辿り着いた

逆に読んで言葉にしていくと、以下のフロー

- `ServlecContextListener`として`ContextLoaderListener`が読み込まれる
- ApplicationContextの読み込み
- Beanの登録(設定ファイル等)
- springのhandlerの仕組みを利用して、`TxNamespaceHandler`を読み込む
- MethodInterceptorとして、`TransactionInterceptor`を定義
- `@Transactional`のついたメソッドに対し、定義されたTransaction処理を実行

`spring.handlers`あたりどうなってるのか気が向いたら見る


