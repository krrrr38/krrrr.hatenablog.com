---
Title: 文字列を返すJavaのHttpClientライブラリ
Category:
- Java
- Scala
Date: 2015-05-30T00:37:16+09:00
URL: https://krrrr.hatenablog.com/entry/2015/05/30/003716
EditURL: https://blog.hatena.ne.jp/krrrr/krrrr.hatenablog.com/atom/entry/8454420450095857661
---

ブラウザなどのHttpClientではGET後に文字列として解釈するために主に以下の2つの方法でcharsetを順に調べる。

- ヘッダからcharsetを得る : `Content-Type: text/html; charset=utf-8`
- 無い場合には、`<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=euc-jp">`のようなタグからcharsetを得る

HttpClientライブラリが文字列を返す際には、このような情報で得たcharsetを使ってデコードした文字列を返して欲しい。
一方、特に後者は、取得したバイト列を何らかのcharsetで文字列にした上でcharsetを探す必要があるため、若干のコストがかかるので、HttpClientライブラリの範疇を超えているのでは、といった懸念点もある。

HttpClientライブラリには文字列をレスポンスボディとして返すものが多いと思うが、それらのライブラリでは文字列化にあたりどのような処理をしているのか見る。

<!-- more -->

## 各種ライブラリ検討
### google-http-java-client (1.21.0-SNAPSHOT)
- [ヘッダのContentTypeを取るが、無ければリクエストに予め付けていたContentTypeヘッダから取得](https://github.com/google/google-http-java-client/blob/346a896b201a784533fab6f5d0214dc62db21a70/google-http-client/src/main/java/com/google/api/client/http/HttpResponse.java#L150-L156)
- 文字列として取得する際には、[レスポンスヘッダとリクエストヘッダしか見ずに、html中のmetaタグは見ないようだ](https://github.com/google/google-http-java-client/blob/346a896b201a784533fab6f5d0214dc62db21a70/google-http-client/src/main/java/com/google/api/client/http/HttpResponse.java#L500-L503)

### okhttp (2.5.0-SNAPSHOT)
- [文字列化するにあたり利用するcharsetを取得する部分](https://github.com/square/okhttp/blob/master/okhttp/src/main/java/com/squareup/okhttp/ResponseBody.java#L86-L89)
- [このcharsetはヘッダからしか読み取られない](https://github.com/square/okhttp/blob/master/okhttp/src/main/java/com/squareup/okhttp/internal/http/RealResponseBody.java#L32-L35)

okhttp、読み込む対象を裏で動いてるワーカに対するキューに対して突っ込むみたいな実装だった

### retrofit (2.0.0-SNAPSHOT)
okhttpの実装に基づく

### AsyncHttpClient (2.0.0-SNAPSHOT)
- [こちらでヘッダにあるContentTypeを探して来るのみ](https://github.com/AsyncHttpClient/async-http-client/blob/master/api/src/main/java/org/asynchttpclient/multipart/PartBase.java#L97-L109)

### jsoup (1.8.2)
- Jsoup.execute(): Response
  - [ヘッダのcharsetを初めに保持](https://github.com/jhy/jsoup/blob/9e97fbf6ada82040f4a49c9aef9a84c983074427/src/main/java/org/jsoup/helper/HttpConnection.java#L550)
  - [`response.body`はその段階のcharsetを用いて文字列を生成](https://github.com/jhy/jsoup/blob/9e97fbf6ada82040f4a49c9aef9a84c983074427/src/main/java/org/jsoup/helper/HttpConnection.java#L602-L612)
  - [`response.parse`はcharsetが無い場合には、中で`meta[http-equiv=content-type]`と`meta[charset]`をさらに探してから文字列を生成](https://github.com/jhy/jsoup/blob/9e97fbf6ada82040f4a49c9aef9a84c983074427/src/main/java/org/jsoup/helper/DataUtil.java#L95)
    - [ただし文字列を生成するのに加えてDocumentオブジェクトも生成されるので若干のコストがかかる](https://github.com/jhy/jsoup/blob/9e97fbf6ada82040f4a49c9aef9a84c983074427/src/main/java/org/jsoup/parser/TreeBuilder.java#L43)
    - `execute`でなく`get`を呼ぶ場合もこれにあたる
- `Jsoup.parse(html)`は当然レスポンスヘッダが無いので、メタタグからcharsetを探すのみの処理を行う

## ついで
Scalaのhttpクライアントも少し見る

### dispatch (0.8.10)
- [ヘッダから探し、無ければリクエストのものを利用する](https://github.com/dispatch/dispatch/blob/bb17d9133b0ac4ce4a205beacf22dd8d0ded45dc/core/src/main/scala/callbacks.scala#L23-L32)
- google-http-java-clientと同じ

### skinny-http-client (1.3.18)
- [ヘッダから探し、無ければリクエストのものを利用する](https://github.com/skinny-framework/skinny-framework/blob/3053609b12e60c064b2b4175e68f2d7414b6d401/http-client/src/main/scala/skinny/http/HTTP.scala#L177-L184)
- google-http-java-clientと同じ

### Scalaのコア機能のみでやる場合

[http://yuroyoro.hatenablog.com/entry/20100917/1284730544:title]

## 結び

思いの他metaタグまで見て文字列にしているライブラリは少なかった。利用者側からしたら文字列が欲しいのは分かるが、世の中にはそううまく行かないサーバも存在する。[ヘッダにcharsetが無く、metaにeuc-jpと書かれたページ](http://www.mozilla.gr.jp/standards/webtips/webtips0033.html)を文字化けせずに取ってこれるライブラリは正しい挙動になってると言える。

今回の例だと、最もシンプルに取るならjsoupで`Jsoup.get().html()`とするのが簡単に行えるものになる。まぁ実際は、`execute()`でResponse取得後、charsetがあれば`body`を、無ければ`response.parse(body).html`の結果を返すのが良いのだが。JsoupもともとDOM解析のような用途に用いられるものだし、この辺もそこそこ（使い方にもよるが）ちゃんとしている雰囲気を感じる。((中の実装はタグが色々と種類に応じて手書きされてて大変そうという印象だったが...))

<s>apache HttpClientのように初めからbyte列を返し、文字列にする過程はHttpClientのライブラリがする範疇ではないと決めつけてしまうのも1つの手だろう。</s>（HttpClientも文字列返す実装あるな...なんか勘違いしてた...）まぁ通常叩くドメインなども限られているし、取りに行くドメインさえ軽く調べて問題なければより柔軟性のある便利なライブラリを使った方が良いのだが...
